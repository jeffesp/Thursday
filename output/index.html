<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Today is Thursday</title>
        <link rel="stylesheet" href="./theme/css/main.css" />
        <link href="https://www.todayisthursday.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Today is Thursday Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">Today is Thursday </a></h1>
                <nav><ul>
                    <li><a href="./category/code.html">Code</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="./simple-sqlite-db-migration.html">Simple SQLite Database Migration</a></h1>
<footer class="post-info">
        <abbr class="published" title="2019-06-18T00:00:00-04:00">
                Published: Tue 18 June 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="./author/jeff-esp.html">Jeff Esp</a>
        </address>
<p>In <a href="./category/code.html">Code</a>.</p>

</footer><!-- /.post-info --><p>I had to write a migration for a SQLite database the other day, and decided
to do some yak-shaving and write the world's simplest db migration utility.
It only migrates one direction, and you have to write migration scripts by
hand. But it seems to work, so here it is.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">migrate_schema</span><span class="p">():</span>
    <span class="n">migrations_path</span> <span class="o">=</span> <span class="s2">&quot;./migrations&quot;</span>
    <span class="c1"># find the database &#39;user_version&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;./db.sqlite3&#39;</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA user_version&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># iterate files in schema dir and find right file to start with</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="n">f</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">migrations_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">migrations_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">current_version</span>
    <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="nb">file</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">migrations_path</span><span class="p">,</span> <span class="n">migration</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">data</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;PRAGMA user_version = {current_version + 1}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Could not execute script {migration}:</span><span class="se">\n</span><span class="s2">{err}&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Database schema up to date at version {current_version}&quot;</span><span class="p">)</span>
</pre></div>


<p>It looks in the current path for a directory named <code>migrations</code> and will run
the files there in number order if the there is named as an integer. This is 
fragile and I'm sure it's going to bite me at some point, but is working so
far. </p>
<p>The <code>PRAGMA</code> stuff could be replaced by a table that keeps track of what the
version, or even has a list of the scripts applied and some tracking data 
about that. For now, <code>user_version</code> is going to work fine.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://www.todayisthursday.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>