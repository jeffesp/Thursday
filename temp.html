<html>

<head>
    <meta charset="utf-8" />
    <link href="styles.css" rel="stylesheet" />
    <title>Simple SQLite Database Migration</title>
</head>

<body>
    <main>
        
<section>
    <header>
        <h1>Simple SQLite Database Migration</h1>
        <p>Posted: 2019-06-18</p>
    </header>
    <article>
        <p>I had to write a migration for a SQLite database the other day, and decided
to do some yak-shaving and write the world's simplest db migration utility.
It only migrates one direction, and you have to write migration scripts by
hand. But it seems to work, so here it is.</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">migrate_schema</span><span class="p">():</span>
    <span class="n">migrations_path</span> <span class="o">=</span> <span class="s2">&quot;./migrations&quot;</span>
    <span class="c1"># find the database &#39;user_version&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;./db.sqlite3&#39;</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA user_version&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># iterate files in schema dir and find right file to start with</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="n">f</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">migrations_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">migrations_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">current_version</span>
    <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="nb">file</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">migrations_path</span><span class="p">,</span> <span class="n">migration</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">data</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;PRAGMA user_version = {current_version + 1}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Could not execute script {migration}:</span><span class="se">\n</span><span class="s2">{err}&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Database schema up to date at version {current_version}&quot;</span><span class="p">)</span>
</pre></div>


<p>It looks in the current path for a directory named <code>migrations</code> and will run
the files there in number order if the there is named as an integer. This is 
fragile and I'm sure it's going to bite me at some point, but is working so
far. </p>
<p>The <code>PRAGMA</code> stuff could be replaced by a table that keeps track of what the
version, or even has a list of the scripts applied and some tracking data 
about that. For now, <code>user_version</code> is going to work fine.</p>
    </article>
</section>

    </main>
    <aside>
        Something Here
    </aside>
</body>

</html>
